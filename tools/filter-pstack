#!/usr/bin/env perl
# $Id$

use strict;
use warnings;

my @thr;

my @ign = (
	[ qw(poll usocklnd_poll_thread psc_usklndthr_begin _pscthr_begin) ],
	[ qw(psc_waitq_waitrel pscfs_fuse_listener_loop) ],
	[ qw(cv_wait taskq_thread_wait taskq_thread) ],
	[ qw(psc_waitq_waitabs pscrpcthr_main _pscthr_begin) ]
);

sub ign_thr {
	for (my $i = 1; $i < @thr; $i++) {
		IGN: foreach my $ign (@ign) {
			my $j = 0;
			foreach my $frame (@$ign) {
				next IGN unless $i + $j < @thr && $thr[$i + $j] =~
				    /^#\d+\s+0x[a-zA-Z0-9]+\s+in\s+$frame\s/;
				$j++;
			}
			return (1);
		}
	}
	return (0);
}

sub print_thr {
	print @thr unless ign_thr;
	@thr = ();
}

while (<>) {
	print_thr if /^Thread /;
	push @thr, $_;
}

print_thr;
