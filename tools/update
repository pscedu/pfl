#!/usr/bin/env bash
# $Id$

# PSC Advanced Systems projects self updater
#
# TODO
# - make a date synchronization primitive:
#	- git checkout `git rev-list -n 1 --before="2009-07-27 13:37" master`

set -e

# Like 'wait' without arguments but returns a nonzero exit status if any
# child reports one.
exwait()
{
	local id st rc=0
	local j=($(jobs -l | awk '{print $2}'))
	set +e
	for pid in ${j[@]}; do
		wait $pid
		st=$?
		if [ $st -eq 127 ]; then
			break
		fi
		[ $rc -ne 0 ] || rc=$st
	done
	set -e
	return $rc
}

warn()
{
	echo "$0: $@" >&2
}

die()
{
	warn "$@"
	exit 1
}

usage()
{
	echo "usage: $0 [command]" >&2
	exit 1
}

reldir=
while getopts "D:" c; do
	case $c in
	D) reldir=${OPTARG%/} ;;
	*) usage ;;
	esac
done
shift $(($OPTIND - 1))

case $1 in
scm-update)
	GIT_ACTION=pull
	;;
*)
	GIT_ACTION=${1#scm-}
	;;
esac

dir=$(readlink -f $(dirname $0)/..)
base=$(basename $dir)

echorun()
{
	echo "$@"
	"$@"
}

_getrepo()
{
	local url=$1
	local dir=$2
	local base=$(basename $dir)

	if [ -n "$reldir" ]; then
		[ x"$reldir" = x"$dir" ] || return 0
	else
		if [ x"$dir" != x"pfl" ]; then
			mkdir -p $dir
			cd $dir
		fi
	fi

	if [ -e .git ]; then
		if [ x"$GIT_ACTION" = x"st" ]; then
			if [ x"$dir" = x"pfl" ]; then
				git $GIT_ACTION
			else
				git $GIT_ACTION | perl -pe "s^(?<=\S)\s(?=\S)^\t$dir/^"
			fi
		else
			git $GIT_ACTION || \
			    warn "accessing $dir failed"
		fi

	elif [ x"$GIT_ACTION" = x"pull" ]; then
		cd ..
		echorun git clone $url $base
	fi
}

getrepo()
{
	_getrepo "$@" &
}

pubrepo()
{
	base=$1
	[ $# -eq 2 ] && base=$2
	getrepo https://github.com/pscedu/${1//\//.}.git $base
}

pubrepo adaptfs
pubrepo conga
pubrepo distrib/fuse
pubrepo distrib/gcrcutil
pubrepo distrib/iozone
pubrepo distrib/libs3
pubrepo distrib/posix-fstest
pubrepo distrib/spiobench
pubrepo distrib/stumbleupon-tcollector
pubrepo idxutils
pubrepo jives
pubrepo mfio
pubrepo psync
pubrepo sft
pubrepo slash2
pubrepo src-upd
pubrepo wokfs
pubrepo xopctl
pubrepo zfs-fuse zfs

for i in $dir/inf/*/update.sh; do
	[ -e $i ] && . $i
done

pubrepo pfl

exwait
