#!/usr/bin/env bash
# $Id$

# PSC Advanced Systems projects self updater
#
# TODO
# parallelize git operations

# open source
#git clone https://github.com/pscedu/proj.git
#cd proj
#./tools/update

set -e

usage()
{
	echo "usage: $0 [command]" >&2
	exit 1
}

if getopts "" c; do
	usage
done
shift $(($OPTIND - 1))

case $1 in
scm-update)
	GIT_ACTION=pull
	SVN_ACTION=up
	;;
scm-status)
	GIT_ACTION=status
	SVN_ACTION=status
	;;
*)
	usage
esac

dir=$(readlink -f $(dirname $0)/..)
base=$(basename $dir)

echorun()
{
	echo "$@"
	"$@"
}

getrepo()
{
	local url=$1
	local dir=$2
	local base=$(basename $dir)

	if [ x"$dir" != x"proj" ]; then
		mkdir -p $dir
		cd $dir
	fi
	if git status >/dev/null 2>&1; then
		pwd
		git $GIT_ACTION

	# XXX remove me
	elif svn info >/dev/null 2>&1; then
		pwd
		svn $SVN_ACTION

	else
		cd ..
		mv $base $base.svnold

		echorun git clone $url $base

		for i in $(cd $base.svnold && find . -type f); do
			mkdir -p $base/$(dirname $i)
			mv -f $base.svnold/$i $base/$i
		done
		find $base.svnold -type l -exec rm {} \;
		find $base.svnold -depth -type d -print -exec rmdir {} \;
	fi
}

pubrepo()
{
	base=$1
	[ $# -eq 2 ] && base=$2
	(getrepo https://github.com/pscedu/${1//\//.}.git $base)
}

pubrepo distrib/fuse
pubrepo distrib/gcrcutil
pubrepo distrib/iozone
pubrepo distrib/libs3
pubrepo distrib/posix-fstest
pubrepo distrib/spiobench
pubrepo distrib/stumbleupon-tcollector
pubrepo fio
pubrepo idxutils
pubrepo psync
pubrepo sft
#pubrepo slash2
pubrepo src-upd
pubrepo xopctl
pubrepo zfs-fuse zfs

for i in $dir/inf/*/update.sh; do
	[ -e $i ] && . $i
done

pubrepo proj

#git checkout `git rev-list -n 1 --before="2009-07-27 13:37" master`
